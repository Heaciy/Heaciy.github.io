<!DOCTYPE html>
<html lang="en-us" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="ä»Observer patternåˆ°Django signal">
<title>Django Signalç®€æ</title>

<link rel='canonical' href='https://heaciy.com/p/django-signal-principle-analysis/'>

<link rel="stylesheet" href="/scss/style.min.7f5ba5a3e5ae89e65fac327867461cc61100abc64c8e215bbfd2701fceb40575.css"><meta property='og:title' content="Django Signalç®€æ">
<meta property='og:description' content="ä»Observer patternåˆ°Django signal">
<meta property='og:url' content='https://heaciy.com/p/django-signal-principle-analysis/'>
<meta property='og:site_name' content='Heaciy&#39;s Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='python' /><meta property='article:tag' content='django' /><meta property='article:published_time' content='2021-06-10T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2021-06-10T00:00:00&#43;00:00'/><meta property='og:image' content='https://images.unsplash.com/photo-1494129935429-873eafa78178?crop=entropy&amp;amp;cs=tinysrgb&amp;amp;fit=max&amp;amp;fm=jpg&amp;amp;ixid=MXwxMTc3M3wwfDF8c2VhcmNofDF8fHNpZ25hbHN8ZW58MHx8fA&amp;amp;ixlib=rb-1.2.1&amp;amp;q=80&amp;amp;w=2000' />
<meta name="twitter:title" content="Django Signalç®€æ">
<meta name="twitter:description" content="ä»Observer patternåˆ°Django signal"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://images.unsplash.com/photo-1494129935429-873eafa78178?crop=entropy&amp;amp;cs=tinysrgb&amp;amp;fit=max&amp;amp;fm=jpg&amp;amp;ixid=MXwxMTc3M3wwfDF8c2VhcmNofDF8fHNpZ25hbHN8ZW58MHx8fA&amp;amp;ixlib=rb-1.2.1&amp;amp;q=80&amp;amp;w=2000' />
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu6707014650456449175.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ¥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Heaciy&#39;s Blog</a></h1>
            <h2 class="site-description">Life is what happens to you while you&#39;re busy making other plans.</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/heaciy'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com/heaciy'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>Dark Mode</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>

        
            <div class="widget--toc--custom">
                <nav id="TableOfContents">
  <ol>
    <li><a href="#è§‚å¯Ÿè€…æ¨¡å¼">è§‚å¯Ÿè€…æ¨¡å¼</a></li>
    <li><a href="#signalç®€è¿°">Signalç®€è¿°</a>
      <ol>
        <li><a href="#1-signal">1. signal</a></li>
        <li><a href="#2-sender">2. sender</a></li>
        <li><a href="#3-receiver">3. receiver</a></li>
      </ol>
    </li>
    <li><a href="#åŸç†ç®€æ">åŸç†ç®€æ</a>
      <ol>
        <li><a href="#1-signalçš„å±æ€§å’Œ__init__æ–¹æ³•">1. Signalçš„å±æ€§å’Œ__init__æ–¹æ³•</a></li>
        <li><a href="#2-signalä¸­çš„æ–¹æ³•">2. Signalä¸­çš„æ–¹æ³•</a></li>
        <li><a href="#3-å¤§æ¦‚æµç¨‹">3. å¤§æ¦‚æµç¨‹</a></li>
        <li><a href="#4-å¾ˆå¥‡æ€ªçš„ä¸€ç‚¹">4. å¾ˆå¥‡æ€ªçš„ä¸€ç‚¹</a></li>
        <li><a href="#5-å¤šè¯´ä¸€å¥">5. å¤šè¯´ä¸€å¥</a></li>
      </ol>
    </li>
    <li><a href="#æºç ç®€æ">æºç ç®€æ</a></li>
    <li><a href="#ä¸€äº›å¯èƒ½æœ‰ç”¨çš„é“¾æ¥">ä¸€äº›å¯èƒ½æœ‰ç”¨çš„é“¾æ¥</a></li>
  </ol>
</nav>
            </div>
        
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/django-signal-principle-analysis/">
                
                    <img src="https://images.unsplash.com/photo-1494129935429-873eafa78178?crop=entropy&amp;amp;cs=tinysrgb&amp;amp;fit=max&amp;amp;fm=jpg&amp;amp;ixid=MXwxMTc3M3wwfDF8c2VhcmNofDF8fHNpZ25hbHN8ZW58MHx8fA&amp;amp;ixlib=rb-1.2.1&amp;amp;q=80&amp;amp;w=2000" loading="lazy" alt="Featured image of post Django Signalç®€æ" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/cs/" >
                CS
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/django-signal-principle-analysis/">Django Signalç®€æ</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            ä»Observer patternåˆ°Django signal
        </h3>
        
    </div>

    
    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jun 10, 2021</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    12 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <blockquote>
<p>æˆ‘æ‰¿è®¤ï¼Œæ˜¯æ ‡é¢˜å…šï¼å“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆï¼Œæœ¬æ¥æ˜¯å‡†å¤‡å†™ä¸€ç¯‡â€œDjango Signalæºç è§£æâ€”â€”ä»Observer Patternåˆ°Django Signalâ€çš„ï¼Œä½†æ˜¯æˆ‘åˆä¸èƒ½ä¸€ä¸¤å¥è¯æŠŠè§‚å¯Ÿè€…æ¨¡å¼è®²æ¸…æ¥šçš„ï¼Œå¹²è„†å°±ç›´æ¥è´´äº†ä¸€äº›ç›¸å…³çš„é“¾æ¥â€¦â€¦åé¢è¶Šå†™è¶Šå¤šã€è¶Šæ‹–è¶Šé•¿å°±å¹²è„†æ”¹æˆç®€æç®—äº†â€¦â€¦<br/>
æœ¬æ–‡åªä½œä¸ºä¸ªäººå­¦ä¹ è®°å½•ï¼Œä»…ä¾›å‚è€ƒï¼Œå¦‚æœ‰è¯¯æ¬¢è¿è®¨è®ºæŒ‡æ­£<br/>
é¢˜å›¾æ¥è‡ª unsplashï¼Œ<a class="link" href="https://images.unsplash.com/photo-1494129935429-873eafa78178?crop=entropy&amp;amp;cs=tinysrgb&amp;amp;fit=max&amp;amp;fm=jpg&amp;amp;ixid=MXwxMTc3M3wwfDF8c2VhcmNofDF8fHNpZ25hbHN8ZW58MHx8fA&amp;amp;ixlib=rb-1.2.1&amp;amp;q=80&amp;amp;w=2000"  target="_blank" rel="noopener"
    >åŸå›¾é“¾æ¥ğŸ”—</a></p>
</blockquote>
<h2 id="è§‚å¯Ÿè€…æ¨¡å¼">è§‚å¯Ÿè€…æ¨¡å¼
</h2><p>â€œè§‚å¯Ÿè€…æ¨¡å¼æ˜¯ä¸€ç§å¯¹è±¡è¡Œä¸ºæ¨¡å¼ã€‚å®ƒå®šä¹‰å¯¹è±¡é—´çš„ä¸€ç§ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»ï¼Œå½“ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡éƒ½å¾—åˆ°é€šçŸ¥å¹¶è¢«è‡ªåŠ¨æ›´æ–°ã€‚<a class="link" href="https://baike.baidu.com/item/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/5881786"  target="_blank" rel="noopener"
    >[1]</a>â€</p>
<p>â€œè§‚å¯Ÿè€…æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ å…è®¸ä½ å®šä¹‰ä¸€ç§è®¢é˜…æœºåˆ¶ï¼Œ å¯åœ¨å¯¹è±¡äº‹ä»¶å‘ç”Ÿæ—¶é€šçŸ¥å¤šä¸ª â€œè§‚å¯Ÿâ€ è¯¥å¯¹è±¡çš„å…¶ä»–å¯¹è±¡ã€‚<a class="link" href="https://refactoringguru.cn/design-patterns/observer"  target="_blank" rel="noopener"
    >[2]</a>â€</p>
<p>è§‚å¯Ÿè€…æ¨¡å¼æœ‰å¤šç§å®ç°æ–¹å¼ï¼Œæ¯”è¾ƒç»å…¸çš„ä¸€ç§å®ç°ï¼Œæœ‰å››ä¸ªè§’è‰²ï¼šSubjectï¼ˆè¢«è§‚å¯Ÿå¯¹è±¡æŠ½è±¡ç±»ï¼‰ã€Observerï¼ˆè§‚å¯Ÿè€…æŠ½è±¡ç±»ï¼‰ã€ConcreateObserverï¼ˆå…·ä½“è§‚å¯Ÿè€…ï¼‰ã€ConcreateSubject(å…·ä½“çš„è¢«è§‚å¯Ÿè€…)â€¦â€¦</p>
<p>è¿™é‡Œå°±ä¸èµ˜è¿°äº†â€¦â€¦å¯ä»¥å‚è§ä¸‹é¢çš„é“¾æ¥</p>
<ul>
<li><a class="link" href="https://en.wikipedia.org/wiki/Observer_pattern"  target="_blank" rel="noopener"
    >wikipediaï¼šObserver pattern</a></li>
<li><a class="link" href="https://baike.baidu.com/item/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/5881786"  target="_blank" rel="noopener"
    >ç™¾åº¦ç™¾ç§‘ï¼šè§‚å¯Ÿè€…æ¨¡å¼</a></li>
<li><a class="link" href="http://c.biancheng.net/view/1390.html"  target="_blank" rel="noopener"
    >è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆObserveræ¨¡å¼ï¼‰è¯¦è§£</a></li>
<li><a class="link" href="https://refactoringguru.cn/design-patterns/observer"  target="_blank" rel="noopener"
    >è§‚å¯Ÿè€…æ¨¡å¼</a></li>
<li><a class="link" href="https://www.runoob.com/design-pattern/observer-pattern.html"  target="_blank" rel="noopener"
    >èœé¸Ÿæ•™ç¨‹ï¼šè§‚å¯Ÿè€…æ¨¡å¼</a></li>
<li><a class="link" href="https://juejin.cn/post/6844903471586476039"  target="_blank" rel="noopener"
    >è§‚å¯Ÿè€…æ¨¡å¼çš„pythonç®€å•å®ç°</a></li>
</ul>
<h2 id="signalç®€è¿°">Signalç®€è¿°
</h2><p>å¯ä»¥å…ˆçœ‹çœ‹Djangoçš„å®˜æ–¹æ–‡æ¡£</p>
<ul>
<li><a class="link" href="https://docs.djangoproject.com/zh-hans/3.0/topics/signals/"  target="_blank" rel="noopener"
    >https://docs.djangoproject.com/zh-hans/3.0/topics/signals/</a></li>
<li><a class="link" href="https://docs.djangoproject.com/zh-hans/3.0/ref/signals/"  target="_blank" rel="noopener"
    >https://docs.djangoproject.com/zh-hans/3.0/ref/signals/</a></li>
</ul>
<p>ä¸è§‚å¯Ÿè€…æ¨¡å¼å¯¹åº”ï¼šsenderå°±æ˜¯è¢«è§‚å¯Ÿè€…ã€receiveræ˜¯è§‚å¯Ÿè€…ã€‚æœ‰æ‰€ä¸åŒçš„å°±æ˜¯å¤šäº†ä¸ªsignalï¼Œä¹Ÿå°±æ˜¯â€œä¿¡å·â€ï¼ˆä¹Ÿå¯ä½¿è¯´æ˜¯ä¿¡å·çš„â€œç®¡ç†è€…â€ï¼‰ã€‚åœ¨æ™®é€šè§‚å¯Ÿè€…æ¨¡å¼ä¸­ï¼Œè¢«è§‚å¯Ÿå¯¹è±¡æŠ½è±¡ç±»ä¸­ä¸€èˆ¬ä¼šç»´æŠ¤ä¸€ä¸ªè§‚å¯Ÿè€…æŠ½è±¡ç±»çš„å¼•ç”¨åˆ—è¡¨ï¼Œä»¥æ­¤æ¥ä¼ é€’æ¶ˆæ¯ï¼Œè€Œdjangoä¸­åˆ™æ˜¯å€ŸåŠ©Signalç±»è¿›ä¸€æ­¥è§£è€¦ï¼Œé€šè¿‡Signalç±»è¿›è¡Œâ€œä¿¡å·ä¼ é€’â€ï¼Œå…·ä½“è§£æå¦‚ä¸‹ï¼š</p>
<h3 id="1-signal">1. signal
</h3><p>ä¿¡å·ç±»ï¼Œç»´æŠ¤ä¸€ä¸ªreceiversåˆ—è¡¨ï¼Œç”¨äºå­˜å‚¨senderå’Œreceiverçš„å¯¹åº”è®°å½•</p>
<p><code>signal.connect()</code>ç”¨äºå¾€<code>signal.receivers</code>ä¸­æ·»åŠ å¯¹åº”çš„receiverå’Œsenderè®°å½•</p>
<p><code>signal_send()</code>ï¼Œåœ¨<code>signal.receivers</code>ä¸­æŸ¥æ‰¾senderå¯¹åº”çš„receiverså¹¶å°†å¯¹åº”ä¿¡å·(å‚æ•°)ä¼ é€’ç»™å¯¹åº”çš„receivers</p>
<p>djangoé¢„ç½®äº†ä¸€äº›ä¿¡å·å¯¹è±¡ï¼Œpre_initã€post_initã€pre_saveã€post_saveç­‰ï¼Œè¿™äº›éƒ½æ˜¯ç›´æ¥æˆ–é—´æ¥çš„ç»§æ‰¿è‡ªSiganlç±»ï¼Œå•ä¸€èŒè´£åŸåˆ™ï¼Œæ¯ä¸ªå…·ä½“çš„ä¿¡å·å¯¹è±¡åªè´Ÿè´£å­˜å‚¨â€œä¸€ç±»ä¿¡å·â€ï¼Œæ¯”å¦‚å‰é¢åˆ—ä¸¾çš„å››ä¸ªä¿¡å·å¯¹è±¡éƒ½æ˜¯django modelç›¸å…³çš„ã€‚ä»¥pre_saveä¸ºä¾‹ï¼Œåªæœ‰åœ¨è°ƒç”¨æŸä¸ªmodelå¯¹è±¡çš„saveæ–¹æ³•æ—¶ï¼ˆå‰ï¼‰æ‰ä¼šè°ƒç”¨pre_save.send()å‘é€ç›¸å…³æ•°æ®ï¼ˆâ€œä¿¡å·â€ï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´pre_saveè¿™ä¸ªSignalå¯¹è±¡çš„receiversåˆ—è¡¨ä¸­å­˜å‚¨çš„senderéƒ½æ˜¯modelè€Œreceiveréƒ½æ˜¯æˆ‘ä»¬å¸Œæœ›åœ¨è¿›è¡Œmodel.save()å‰è°ƒç”¨çš„å‡½æ•°æ¥è¿›è¡Œçš„ä¸€äº›ç›¸å…³æ“ä½œã€‚</p>
<h3 id="2-sender">2. sender
</h3><p>ä¿¡å·çš„å‘é€æ–¹ï¼Œå³è°ƒç”¨<code>signal.send()</code>æ–¹æ³•çš„ç±»ã€‚æ¯”å¦‚ï¼Œæ‰€æœ‰modelç±»çš„çˆ¶ç±»éƒ½æ˜¯BaseModelï¼Œè€ŒBaseModelæœ‰ä¸€ä¸ª__init__å‡½æ•°åœ¨è¯¥å‡½æ•°ä¸­ï¼Œé¦–å…ˆå°±ä¼šè°ƒç”¨<code>pre_init.send(self.__class__,**kwargs)</code>å‘é€å³å°†å¼€å§‹initçš„ä¿¡å·ï¼Œç„¶åå†è¿›è¡Œå…·ä½“çš„initæ“ä½œï¼Œåœ¨initä¹‹åå†è°ƒç”¨<code>post_init.send</code>å‘é€initå®Œæˆçš„ä¿¡å·ã€‚æ•…è¿™é‡Œçš„BaseModelç±»å°±æ˜¯è¿™ä¸¤ä¸ªä¿¡å·å¯¹è±¡(pre_initã€post_init)çš„senderã€‚è€Œæˆ‘ä»¬çš„modelç±»éƒ½æ˜¯ç»§æ‰¿è‡ªBaseModelï¼Œinitæ–¹æ³•ä¹Ÿæ˜¯ç»§æ‰¿æ¥çš„ï¼Œæ•…æ­¤æ—¶çš„senderå°±æ˜¯æˆ‘ä»¬å®šä¹‰çš„modelç±»ã€‚</p>
<h3 id="3-receiver">3. receiver
</h3><p>ä¿¡å·çš„æ¥æ”¶æ–¹ï¼Œä¸ºå¯è°ƒç”¨å¯¹è±¡ï¼Œä¸€èˆ¬æ˜¯ä¸ªå‡½æ•°ï¼Œæ¥æ”¶signal.send()ä¼ é€’è¿‡æ¥çš„å‚æ•°ï¼Œå†è¿›è¡Œç›¸å…³çš„æ“ä½œ</p>
<p>å‡å¦‚æˆ‘ä»¬æœ‰ä¸ªmodelå¯¹è±¡ä¸ºPeopleï¼Œæˆ‘ä»¬æƒ³è¦åœ¨æ„é€ æ¯ä¸€ä¸ªPeopleæ—¶ï¼ˆ<code>new_peopleÂ = People(name=&quot;haha&quot;,email=&quot;haha@mail.com&quot;)</code>ï¼‰æ‰“å°å‡ºå…¶ç›¸å…³ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªå‡½æ•°æ‰“å°å…¶ä¿¡æ¯ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">print_info</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;args: </span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="se">\n</span><span class="s2">kwargs: </span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åä½¿ç”¨<code>pre_init.connect(print_info, sender=People)</code>å°†å…¶ä¸senderç»‘å®šèµ·æ¥,å³åœ¨pre_initçš„receiversåˆ—è¡¨ä¸­å­˜ä¸€æ¡å¯¹åº”çš„è®°å½•:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="p">((</span><span class="n">People_id</span><span class="p">,</span><span class="n">print_info_id</span><span class="p">),</span><span class="n">print_info_weakref</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ­¤å¤„çš„<code>print_info</code>å‡½æ•°å³ä¸ºä¸€ä¸ªreceiverï¼Œpre_initä¿¡å·ä¸­Peopleç±»å¯¹åº”çš„receiverã€‚</p>
<p>å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨è£…é¥°å™¨ï¼Œä¸è¿‡ä¹Ÿæ˜¯åŒæ ·çš„é“ç†</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@receiver</span><span class="p">(</span><span class="n">pre_init</span><span class="p">,</span><span class="n">sender</span><span class="o">=</span><span class="n">People</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">print_info_before_init</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;args: </span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="se">\n</span><span class="s2">kwargs: </span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æœ€ç»ˆæ‰“å°å‡ºæ¥çš„ç»“æœæ˜¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">args: []
</span></span><span class="line"><span class="cl">kwargs: {&#39;name&#39;:&#39;haha&#39;,&#39;email&#39;:&#39;haha.mail.com&#39;}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="åŸç†ç®€æ">åŸç†ç®€æ
</h2><p>djangoçš„æ•´ä¸ªä¿¡å·æ¨¡å—éƒ½æ˜¯ä¾èµ–Signalè¿™ä¸ªç±»å®Œæˆçš„</p>
<p><img src="/p/django-signal-principle-analysis/signal.png"
	width="373"
	height="569"
	srcset="/p/django-signal-principle-analysis/signal_hu8251001186732828751.png 480w, /p/django-signal-principle-analysis/signal_hu17536644674691067904.png 1024w"
	loading="lazy"
	
		alt="Signal Class Diagram"
	
	
		class="gallery-image" 
		data-flex-grow="65"
		data-flex-basis="157px"
	
>
<img src="/p/django-signal-principle-analysis/signal_detail.png"
	width="956"
	height="538"
	srcset="/p/django-signal-principle-analysis/signal_detail_hu3840407809679362127.png 480w, /p/django-signal-principle-analysis/signal_detail_hu9076136509210613243.png 1024w"
	loading="lazy"
	
		alt="Signal Class Diagram Detail"
	
	
		class="gallery-image" 
		data-flex-grow="177"
		data-flex-basis="426px"
	
></p>
<h3 id="1-signalçš„å±æ€§å’Œ__init__æ–¹æ³•">1. Signalçš„å±æ€§å’Œ__init__æ–¹æ³•
</h3><p>1.receiversï¼šä¸€ä¸ªåˆ—è¡¨ç”¨äºå­˜å–è¯¥Signalä¸­å¯¹åº”çš„senderå’Œreceiverå¹¶å­˜ä¸‹receiverçš„å¼•ç”¨(æˆ–å¼±å¼•ç”¨)ï¼Œåœ¨è°ƒç”¨connect()æ–¹æ³•æ—¶ä¼šå¾€receiversä¸­æ·»åŠ å¯¹åº”å…³ç³»ï¼Œè€Œåœ¨è°ƒç”¨send()æ–¹æ³•æ—¶ä¼šåœ¨å…¶ä¸­æŸ¥æ‰¾å¯¹åº”å…³ç³»</p>
<p>æ•°æ®ç»“æ„ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># å¦‚æœåœ¨è°ƒç”¨connectæ–¹æ³•æ·»åŠ æ—¶weakå‚æ•°ä¸ºTrueï¼ˆé»˜è®¤ä¸ºTrueï¼‰</span>
</span></span><span class="line"><span class="cl"><span class="c1"># åˆ™å­˜å‚¨receiverçš„å¼±å¼•ç”¨ï¼Œåœ¨åƒåœ¾å›æ”¶æ—¶ä¼šè‡ªåŠ¨å¤„ç†</span>
</span></span><span class="line"><span class="cl"><span class="p">[((</span><span class="n">receiver_id</span><span class="p">,</span><span class="n">sender_id</span><span class="p">),</span><span class="n">receiver_weakref</span><span class="p">),]</span>  <span class="c1"># å¼±å¼•ç”¨</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># å¦‚æœconnectæ–¹æ³•çš„weakå‚æ•°ä¸ºFalse</span>
</span></span><span class="line"><span class="cl"><span class="c1"># åˆ™å­˜å‚¨receiverçš„å¼ºå¼•ç”¨ï¼Œæœ€ç»ˆéœ€è¦è°ƒç”¨disconnecté”€æ¯è®°å½•</span>
</span></span><span class="line"><span class="cl"><span class="c1"># å¦åˆ™ç›¸å…³å˜é‡æ— æ³•è¢«åƒåœ¾å›æ”¶ï¼Œä¹Ÿå°±æ˜¯â€å†…å­˜æ³„éœ²â€œ</span>
</span></span><span class="line"><span class="cl"><span class="p">[((</span><span class="n">receiver_id</span><span class="p">,</span><span class="n">sender_id</span><span class="p">),</span><span class="n">receiver</span><span class="p">),]</span>  <span class="c1"># å¼ºå¼•ç”¨</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>2.providing_argsï¼šè¯¥signalæ¥å—çš„å‚æ•°çš„åˆ—è¡¨</p>
<p>3.lockï¼šthreading.lockï¼Œå¯¹ç›¸åº”æ“ä½œåŠ é”ä»¥ä¿è¯å®‰å…¨</p>
<p>4.use_cachingï¼šboolç±»å‹ï¼Œæ ‡è¯†æ˜¯å¦ä½¿ç”¨ç¼“å­˜ï¼Œå¦‚æœä½¿ç”¨ç¼“å­˜æˆ‘ä»¬ä¼šç¼“å­˜æ¯ä¸€ä¸ªsenderç±»çš„receiverså¹¶å­˜å‚¨åˆ°self.sender_receivers_cacheä¸­</p>
<p>5.sender_receivers_cacheï¼šsignalå¯¹æ¯ä¸€ä¸ªsenderçš„receiversè¿›è¡Œç¼“å­˜</p>
<p>æ•°æ®ç»“æ„ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sender1&#34;</span><span class="p">:</span> <span class="p">[</span><span class="err">receiver</span><span class="mi">1</span><span class="err">_weakref</span><span class="p">,</span> <span class="err">receiver</span><span class="mi">2</span><span class="err">_weakref</span><span class="p">,</span><span class="err">...</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sender2&#34;</span><span class="p">:</span> <span class="p">[</span><span class="err">receiver</span><span class="mi">3</span><span class="err">_weakref</span><span class="p">,</span> <span class="err">receiver</span><span class="mi">4</span><span class="err">_weakref</span><span class="p">,</span><span class="err">...</span><span class="p">],</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ¯æ¬¡sendæ—¶ä¼šä½¿ç”¨sender_receivers_cacheå¿«é€Ÿåˆ¤æ–­è¯¥senderæ˜¯å¦æœ‰receiverï¼Œå¦‚æœæœ‰åˆ™å†è°ƒç”¨_live_receiversè·å–å…¶å¯¹åº”çš„receiversçš„å¼ºåº”ç”¨åˆ—è¡¨</p>
<p>6._dead_receiversï¼šboolç±»å‹ï¼Œç”¨äºæ ‡è¯†self.reiversä¸­æ˜¯å¦å«æœ‰å¤±æ•ˆçš„ receiverçš„å¼±å¼•ç”¨ã€‚å½“å¼±å¼•ç”¨æŒ‡å‘çš„receiverè¢«åƒåœ¾å›æ”¶æ—¶ä¼šè°ƒç”¨Signal._remove_receiveræ–¹æ³•å°†_dead_receiversç½®ä¸ºTrue</p>
<h3 id="2-signalä¸­çš„æ–¹æ³•">2. Signalä¸­çš„æ–¹æ³•
</h3><p>è¯´åœ¨å‰é¢ï¼šreceiverå’Œsenderéƒ½å¿…é¡»æ˜¯<a class="link" href="https://stackoverflow.com/questions/14535730/what-does-hashable-mean-in-python"  target="_blank" rel="noopener"
    >å¯å“ˆå¸Œçš„</a></p>
<p>1.connectï¼šå°†receiverå’Œsenderé€šè¿‡å¯¹åº”çš„Signalè¿æ¥èµ·æ¥ï¼ˆå³å°†å¯¹åº”è®°å½•æ·»åŠ åˆ°å¯¹åº”Signalå¯¹è±¡çš„receiverså±æ€§åˆ—è¡¨ä¸­ï¼‰</p>
<p>å‚æ•°è§£æï¼š</p>
<ul>
<li>receiverï¼šéœ€è¦æ¥æ”¶ä¿¡å·çš„receiver</li>
<li>senderï¼šå‘é€è¯¥ä¿¡å·çš„sender</li>
<li>weakï¼šæ˜¯å¦ä½¿ç”¨å¼±å¼•ç”¨ï¼Œé»˜è®¤ä¸ºTrueã€‚å¦‚æœä¸ºTrueåˆ™å­˜å‚¨receiverå¯¹åº”çš„weakrefå¦åˆ™ç›´æ¥å­˜å‚¨å¼ºå¼•ç”¨ã€‚ç”±äºè®¾ç½®äº†<code>weakref.finalize(receiver_object, self._remove_receiver)</code>è‹¥å­˜å‚¨å¼±å¼•ç”¨åˆ™å¯ä»¥åœ¨receiveråƒåœ¾å›æ”¶æ—¶è‡ªåŠ¨æ¸…é™¤Signal.receiversä¸­å¯¹åº”çš„è®°å½•ï¼ˆè§ä¸‹é¢çš„åˆ†æï¼‰è‹¥å­˜å‚¨å¼ºå¼•ç”¨åˆ™éœ€è¦å…ˆæ‰‹åŠ¨è°ƒç”¨disconnectæ–¹æ³•åˆ é™¤Signal.receiversä¸­å¯¹åº”çš„è®°å½•å¦åˆ™è¯¥receiverå°†æ— æ³•è¢«åƒåœ¾å›æ”¶å¯¼è‡´â€œå†…å­˜æ³„æ¼â€</li>
<li>dispatch_uidï¼šé»˜è®¤ä¸ºNoneï¼Œå¦‚æœä½¿ç”¨äº†è¯¥å€¼ï¼ˆä¸€èˆ¬ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼‰ï¼Œç›¸å½“äºä¸ºè¯¥receiverè‡ªå®šä¹‰ä¸ªå”¯ä¸€åç§°ï¼ˆä¸å…è®¸é‡å¤ï¼‰ï¼Œå­˜å‚¨æ—¶å°†ä¼šä½¿ç”¨<code>dispatch_uid</code>ä»£æ›¿<code>id(sender)</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">receiver</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">weak</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dispatch_uid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">dispatch_uid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">lookup_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">dispatch_uid</span><span class="p">,</span> <span class="n">_make_id</span><span class="p">(</span><span class="n">sender</span><span class="p">))</span>  <span class="c1"># å¦‚æœè®¾ç½®äº†dispatch_uidåˆ™ä½¿ç”¨å…¶æœŸå¾…idå€¼ä½œä¸ºå”¯ä¸€æ ‡è¯†</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">lookup_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">_make_id</span><span class="p">(</span><span class="n">receiver</span><span class="p">),</span> <span class="n">_make_id</span><span class="p">(</span><span class="n">sender</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">weak</span><span class="p">:</span>  <span class="c1"># å¦‚æœä½¿ç”¨å¼±å¼•ç”¨</span>
</span></span><span class="line"><span class="cl">        <span class="n">ref</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span>
</span></span><span class="line"><span class="cl">        <span class="n">receiver_object</span> <span class="o">=</span> <span class="n">receiver</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Check for bound methods</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">receiver</span><span class="p">,</span> <span class="s1">&#39;__self__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">receiver</span><span class="p">,</span> <span class="s1">&#39;__func__&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># å¦‚æœè¯¥receiveræ˜¯å¯¹è±¡æ–¹æ³•ï¼Œåˆ™receiver_objectä¸ºåŒ…å«è¯¥receiverçš„å¯¹è±¡</span>
</span></span><span class="line"><span class="cl">            <span class="n">ref</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakMethod</span>
</span></span><span class="line"><span class="cl">            <span class="n">receiver_object</span> <span class="o">=</span> <span class="n">receiver</span><span class="o">.</span><span class="vm">__self__</span>
</span></span><span class="line"><span class="cl">        <span class="n">receiver</span> <span class="o">=</span> <span class="n">ref</span><span class="p">(</span><span class="n">receiver</span><span class="p">)</span>  <span class="c1"># è·å–è¯¥receiverçš„å¼±å¼•ç”¨</span>
</span></span><span class="line"><span class="cl">        <span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">receiver_object</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_receiver</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># receiver_objectåƒåœ¾å›æ”¶æ—¶è°ƒç”¨self._remove_receiverå°†self._dead_receiversç½®ä¸ºTrue</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># åœ¨åé¢çš„sendæˆ–send_robustä¸­å¯¹self.receiversåŠ é”åæ¸…ç†</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_clear_dead_receivers</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">r_key</span> <span class="o">==</span> <span class="n">lookup_key</span> <span class="k">for</span> <span class="n">r_key</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">receivers</span><span class="p">):</span>  <span class="c1"># æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">receivers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">lookup_key</span><span class="p">,</span> <span class="n">receiver</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">sender_receivers_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># æ¯æ¬¡connectæˆ–disconnectåéƒ½è¦æ¸…é™¤ç¼“å­˜</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è¯¥ç¼“å­˜ä¼šåœ¨sendæ—¶æ„å»º</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>â€‹</p>
<p>2.disconnectï¼šä»å¯¹åº”Signalå¯¹è±¡çš„receiversåˆ—è¡¨ä¸­åˆ é™¤å¯¹åº”è®°å½•ï¼ˆä¸€èˆ¬ç”¨äºæ‰‹åŠ¨åˆ é™¤åœ¨connectæ—¶ä½¿ç”¨weak=Falseçš„æƒ…å†µï¼Œå³è¯¥æ¡è®°å½•å­˜çš„æ˜¯receiverçš„å¼ºå¼•ç”¨ï¼Œè‹¥ä¸æ‰‹åŠ¨åˆ é™¤è¯¥æ¡è®°å½•ä¼šå¯¼è‡´â€œå†…å­˜æ³„æ¼â€ï¼Œä¸<a class="link" href="https://docs.python.org/zh-cn/3.8/library/gc.html"  target="_blank" rel="noopener"
    >gcçš„å¼•ç”¨è®¡æ•°</a>æœ‰å…³ï¼‰</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">receiver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dispatch_uid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    å°†signalä¸­çš„receiverä¸senderâ€œæ–­å¼€è¿æ¥â€
</span></span></span><span class="line"><span class="cl"><span class="s2">    è¯¥å‡½æ•°ä¸»è¦é’ˆå¯¹é‚£äº›åœ¨connectæ—¶weakå‚æ•°ä¸ºFalseçš„æƒ…å†µï¼Œå³signalçš„receiversåˆ—è¡¨
</span></span></span><span class="line"><span class="cl"><span class="s2">    ä¸­å­˜å‚¨çš„æ˜¯rceiverçš„å¼ºå¼•ç”¨
</span></span></span><span class="line"><span class="cl"><span class="s2">    
</span></span></span><span class="line"><span class="cl"><span class="s2">    å¦‚æœåœ¨connectæ—¶ä½¿ç”¨çš„å¼±å¼•ç”¨(weak=True), åˆ™ä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨disconnectæ–¹æ³•
</span></span></span><span class="line"><span class="cl"><span class="s2">    receiverå’Œsenderçš„è®°å½•ä¼šè¢«è‡ªåŠ¨åˆ é™¤
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">dispatch_uid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">lookup_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">dispatch_uid</span><span class="p">,</span> <span class="n">_make_id</span><span class="p">(</span><span class="n">sender</span><span class="p">))</span>  <span class="c1"># å¦‚æœæä¾›äº†dispatch_uidåˆ™ä½¿ç”¨å…¶æ›¿ä»£ id(receiver)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">lookup_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">_make_id</span><span class="p">(</span><span class="n">receiver</span><span class="p">),</span> <span class="n">_make_id</span><span class="p">(</span><span class="n">sender</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">disconnected</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_clear_dead_receivers</span><span class="p">()</span>  <span class="c1"># å…ˆæ¸…é™¤dead_receivers</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">receivers</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="n">r_key</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">receivers</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">r_key</span> <span class="o">==</span> <span class="n">lookup_key</span><span class="p">:</span>  <span class="c1"># æ ¹æ®lookup_keyåœ¨self.receiversä¸­æŸ¥æ‰¾</span>
</span></span><span class="line"><span class="cl">                <span class="n">disconnected</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">receivers</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>  <span class="c1"># åˆ é™¤self.receiversä¸­çš„å¯¹åº”è®°å½•</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">sender_receivers_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="c1"># å˜æ›´åæ¸…é™¤ç¼“å­˜</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">disconnected</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>â€‹</p>
<p>3.has_listenersï¼šæ£€æŸ¥æŸä¸ªsenderæ˜¯å¦æœ‰receiver</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">has_listeners</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_live_receivers</span><span class="p">(</span><span class="n">sender</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>â€‹</p>
<p>4.sendï¼šç»™æŸä¸ªsenderå¯¹åº”çš„æ‰€æœ‰receiverså‘é€ç›¸åº”çš„ä¿¡å·ï¼Œé¦–å…ˆä¼šæ£€æŸ¥è¿™ä¸ªsenderæ˜¯å¦æœ‰receiversã€‚å¦‚æœæœ‰ï¼Œå…ˆè°ƒç”¨_live_receiversè·å–å½“å‰senderå¯¹åº”çš„æ‰€æœ‰çš„receiverçš„å¼ºå¼•ç”¨ï¼Œç„¶åä¾æ¬¡è°ƒç”¨æ¯ä¸ªreceiverä¼ å…¥ç›¸å…³çš„å‚æ•°ã€‚æœ€åï¼Œè¿”å›<code>[(receiver,response),]</code>ï¼ˆè¿™é‡Œçš„receiveræ˜¯å¼ºå¼•ç”¨å³å¯ç›´æ¥è°ƒç”¨çš„receiverå‡½æ•°ï¼Œresponseæ˜¯è°ƒç”¨receiverå‡½æ•°è¿”å›çš„ç»“æœï¼‰</p>
<p>å‚æ•°è§£æï¼š</p>
<ul>
<li>senderï¼šå‘é€ä¿¡å·çš„ç±»</li>
<li>**namedï¼šä¼ é€’ç»™è¯¥senderå¯¹åº”çš„receiversçš„å‚æ•°</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="o">**</span><span class="n">named</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">receivers</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender_receivers_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span> <span class="ow">is</span> <span class="n">NO_RECEIVERS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">receiver</span><span class="p">,</span> <span class="n">receiver</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">sender</span><span class="p">,</span> <span class="o">**</span><span class="n">named</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">receiver</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_live_receivers</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span>  <span class="c1"># _live_receiversè¿”å›çš„æ˜¯è¯¥senderå¯¹åº”çš„æ‰€æœ‰çš„receiversçš„å¼ºå¼•ç”¨</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>æ³¨ï¼š</strong> å½“è°ƒç”¨æŸä¸ªreceiverå‘ç”Ÿå¼‚å¸¸æ—¶ç¨‹åºä¼šç›´æ¥é€€å‡ºï¼Œå¯èƒ½å¯¼è‡´å…¶ä»–å‰©ä¸‹çš„receiverå¹¶æ²¡æœ‰è¢«è°ƒç”¨æ‰§è¡Œ</p>
<p>â€‹</p>
<p>5.send_robustï¼šâ€œå¥å£®ç‰ˆâ€çš„sendï¼Œå½“è°ƒç”¨æŸä¸ªreceiverå‘ç”Ÿå¼‚å¸¸æ—¶ä¼šå°†å¼‚å¸¸æ•æ‰å¹¶å­˜å‚¨èµ·æ¥ï¼Œæ•…è¯¥senderçš„æ‰€æœ‰çš„receiveréƒ½èƒ½è¢«è°ƒç”¨æ‰§è¡Œã€‚è¯¥å‡½æ•°ä¼šè¿”å›<code>[(receiver,response / err),]</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">send_robust</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="o">**</span><span class="n">named</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ç›¸æ¯”sendæ–¹æ³•è°ƒç”¨receiveræ–¹æ³•å¼‚å¸¸æ—¶ç›´æ¥é€€å‡ºï¼Œsend_robustä¼šæ”¶é›†å¼‚å¸¸å¹¶è¿”å›</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">receivers</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender_receivers_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span> <span class="ow">is</span> <span class="n">NO_RECEIVERS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Call each receiver with whatever arguments it can accept.</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Return a list of tuple pairs [(receiver, response), ... ].</span>
</span></span><span class="line"><span class="cl">    <span class="n">responses</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">receiver</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_live_receivers</span><span class="p">(</span><span class="n">sender</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">response</span> <span class="o">=</span> <span class="n">receiver</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">sender</span><span class="p">,</span> <span class="o">**</span><span class="n">named</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">responses</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">receiver</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">            <span class="c1"># å¦‚æœè°ƒç”¨receiverå‡ºç°å¼‚å¸¸åˆ™æ•è·å¹¶è¿”å›ç›¸åº”çš„å¼‚å¸¸è€Œä¸å½±å“å…¶ä»–receiverçš„è°ƒç”¨</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">responses</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">receiver</span><span class="p">,</span> <span class="n">response</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">responses</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>â€‹</p>
<p>6._clean_dead_receiversï¼šæ¸…é™¤Signal.receiversä¸­çš„dead receiverï¼Œè¯¥å‡½æ•°ä¼šåœ¨sendæˆ–send_robustä¸­å¯¹Signal.receiversåŠ é”äº†çš„æƒ…å†µä¸‹è°ƒç”¨</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_clear_dead_receivers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Note: caller is assumed to hold self.lock.</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># æ¸…é™¤dead_receivers</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dead_receivers</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_dead_receivers</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># è¿˜åŸ_dead_receiversä¸ºFalse</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">receivers</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">receivers</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ReferenceType</span><span class="p">)</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># å¼±å¼•ç”¨ï¼Œå¹¶ä¸”è¯¥å¼±å¼•ç”¨å¯¹åº”çš„å¯¹è±¡å·²æ¶ˆäº¡</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>â€‹</p>
<p><strong>æ³¨ï¼š</strong> å…¶å®è¿™é‡Œè¯´çš„æ¸…é™¤dead receiverï¼Œå°±æ˜¯åˆ é™¤Signal.receiversä¸­é‚£äº›åŸå‡½æ•°/å¯¹è±¡ï¼ˆå³receiverå‡½æ•°æˆ–åŒ…å«receievrå‡½æ•°çš„å¯¹è±¡ï¼‰å·²ç»è¢«åƒåœ¾å›æ”¶äº†çš„weakrefï¼Œè‡³äºé‚£äº›åœ¨connectæ—¶ä½¿ç”¨weak=Falseæ·»åŠ çš„å¼ºå¼•ç”¨åˆ™éœ€è¦æ‰‹åŠ¨è°ƒç”¨disconnectè¿›è¡Œæ‰‹åŠ¨æ¸…é™¤ï¼Œå¦åˆ™å¯èƒ½ä¼šå¯¼è‡´å†…å­˜æ³„éœ²</p>
<p>7._live_receiversï¼šå…ˆé€šè¿‡self._dead_receiversæ£€æŸ¥æ˜¯å¦æœ‰dead receiverså¦‚æœæœ‰åˆ™å…ˆè¿‡æ»¤ä¸€éSignal.receiversï¼Œç„¶åä»Signal.receiversä¸­æ‰¾å‡ºè¯¥senderå¯¹åº”æ‰€æœ‰çš„receiverï¼Œå¹¶è¿”å›åŒ…å«æ‰€æœ‰receiverå¼ºå¼•ç”¨çš„åˆ—è¡¨</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_live_receivers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Filter sequence of receivers to get resolved, live receivers.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    This checks for weak references and resolves them, then returning only
</span></span></span><span class="line"><span class="cl"><span class="s2">    live receivers.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">receivers</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_caching</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dead_receivers</span><span class="p">:</span>  <span class="c1"># å¦‚æœä½¿ç”¨ç¼“å­˜å¹¶ä¸”self.receiversä¸­æ— dead_receivers</span>
</span></span><span class="line"><span class="cl">        <span class="n">receivers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender_receivers_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span>  <span class="c1"># ç›´æ¥ä»ç¼“å­˜ä¸­è·å–</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># We could end up here with NO_RECEIVERS even if we do check this case in</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># .send() prior to calling _live_receivers() due to concurrent .send() call.</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å…¶å®æˆ‘ä»¬åœ¨è°ƒç”¨_live_receiversæ–¹æ³•çš„sendæ–¹æ³•ä¸­å·²ç»æ£€æŸ¥è¿‡ä¸€æ¬¡äº†</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">receivers</span> <span class="ow">is</span> <span class="n">NO_RECEIVERS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">receivers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># å¦‚æœä¸ä½¿ç”¨ç¼“å­˜æˆ–è€…å­˜åœ¨å¾…æ¸…ç†çš„dead receivers</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_clear_dead_receivers</span><span class="p">()</span>  <span class="c1"># å…ˆæ¸…ç†dead_receivers</span>
</span></span><span class="line"><span class="cl">            <span class="n">senderkey</span> <span class="o">=</span> <span class="n">_make_id</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">receivers</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="n">receiverkey</span><span class="p">,</span> <span class="n">r_senderkey</span><span class="p">),</span> <span class="n">receiver</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">receivers</span><span class="p">:</span> <span class="c1"># éå†self.receiversè¿›è¡ŒæŸ¥æ‰¾åŒ¹é…</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">r_senderkey</span> <span class="o">==</span> <span class="n">NONE_ID</span> <span class="ow">or</span> <span class="n">r_senderkey</span> <span class="o">==</span> <span class="n">senderkey</span><span class="p">:</span>  <span class="c1"># å¦‚æœsenderkeyä¸ºid(None)æˆ–åŒ¹é…</span>
</span></span><span class="line"><span class="cl">                    <span class="n">receivers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">receiver</span><span class="p">)</span>  <span class="c1"># å°†receiver(weakref)æ·»åŠ åˆ°receiversä¸­</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># æ›´æ–°ç¼“å­˜</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_caching</span><span class="p">:</span>  <span class="c1"># å¦‚æœä½¿ç”¨ç¼“å­˜</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">receivers</span><span class="p">:</span>  <span class="c1"># å¦‚æœè¯¥senderæ²¡æœ‰receiver (receiversä¸ºç©º)</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">sender_receivers_cache</span><span class="p">[</span><span class="n">sender</span><span class="p">]</span> <span class="o">=</span> <span class="n">NO_RECEIVERS</span>  <span class="c1"># å°†cacheä¸­è¯¥senderçš„receiversç½®ä¸ºç©º</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>  <span class="c1"># å¦‚æœè¯¥senderå­˜åœ¨å¯¹åº”çš„receiver</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># Note, we must cache the weakref versions.</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># æ³¨æ„æˆ‘ä»¬åº”è¯¥ç¼“å­˜å¼±å¼•ç”¨</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">sender_receivers_cache</span><span class="p">[</span><span class="n">sender</span><span class="p">]</span> <span class="o">=</span> <span class="n">receivers</span>  <span class="c1"># å°†è¯¥senderåŠå…¶æ‰€æœ‰çš„receiversç¼“å­˜èµ·æ¥</span>
</span></span><span class="line"><span class="cl">    <span class="n">non_weak_receivers</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">receiver</span> <span class="ow">in</span> <span class="n">receivers</span><span class="p">:</span>  <span class="c1"># receiversè¦ä¹ˆä¸º[] è¦ä¹ˆä¸º[receiver]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">receiver</span><span class="p">,</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ReferenceType</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Dereference the weak reference.</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># https://www.kite.com/python/docs/weakref.ReferenceType</span>
</span></span><span class="line"><span class="cl">            <span class="n">receiver</span> <span class="o">=</span> <span class="n">receiver</span><span class="p">()</span>  <span class="c1"># è·å–å¼±å¼•ç”¨æ‰€æŒ‡çš„å®é™…å¯¹è±¡ï¼Œè‹¥å·²æ¶ˆäº¡åˆ™è¿”å›Noneï¼Œå¦åˆ™è¿”å›å¯¹è±¡çš„å¼ºå¼•ç”¨(â€œå¯ç›´æ¥è°ƒç”¨â€)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">receiver</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># weakrefæ‰€æŒ‡çš„åŸå¯¹è±¡å°šæœªæ¶ˆäº¡</span>
</span></span><span class="line"><span class="cl">                <span class="n">non_weak_receivers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">receiver</span><span class="p">)</span>  <span class="c1"># æ·»åŠ å®é™…å¯è°ƒç”¨çš„receiverå¯¹è±¡</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">non_weak_receivers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">receiver</span><span class="p">)</span>  <span class="c1"># ä¸æ˜¯å¼±å¼•ç”¨åˆ™ç›´æ¥æ·»åŠ </span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">non_weak_receivers</span>  <span class="c1"># å¯è°ƒç”¨å¯¹è±¡receiverçš„åˆ—è¡¨</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>8._remove_receiversï¼šå°†Signal._dead_receiversç½®ä¸ºTrueï¼Œåœ¨åé¢è°ƒç”¨sendæˆ–send_robustæ–¹æ³•æ—¶ä¼šå…ˆæ£€æŸ¥_dead_receiversï¼Œå¦‚æœä¸ºTrueåˆ™å…ˆè°ƒç”¨_clean_dead_receiversè¿›è¡Œæ¸…ç†</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_remove_receiver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">receiver</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Mark that the self.receivers list has dead weakrefs. If so, we will</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># clean those up in connect, disconnect and _live_receivers while</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># holding self.lock. Note that doing the cleanup here isn&#39;t a good</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># idea, _remove_receiver() will be called as side effect of garbage</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># collection, and so the call can happen while we are already holding</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># self.lock.</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># æ ‡è®°self.receiversä¸­æœ‰dead weakrefs(weakrefæ‰€æŒ‡å¯¹è±¡å·²æ¶ˆäº¡).å¦‚æœå­˜åœ¨dead receiver</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ç¨‹åºä¼šåœ¨è°ƒç”¨connect, disconnectå’Œ_live_receiversæ—¶åœ¨åŠ é”çš„æƒ…å†µä¸‹æ¸…é™¤dead weakrefs</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># æ³¨æ„åœ¨è¿™é‡Œæ‰§è¡Œå…·ä½“çš„æ¸…é™¤æ“ä½œå¹¶ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ï¼Œåœ¨åƒåœ¾å›æ”¶æ—¶_remove_receiver()ä¼šè¢«</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># è‡ªåŠ¨è§¦å‘ï¼Œè€Œæˆ‘ä»¬å¯èƒ½åœ¨å…¶ä»–æ“ä½œä¸­å¯¹receiversåŠ äº†é”ï¼Œæ­¤æ—¶æ¸…ç†receiverså°†ä¼šå¯¼è‡´å†²çª</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">_dead_receivers</span> <span class="o">=</span> <span class="kc">True</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>æ³¨ï¼š</strong> ç”±äºåœ¨connectæ–¹æ³•ä¸­çš„è®¾ç½®äº†<code>weakref.finalize(receiver_object, self._remove_receiver)</code>ï¼Œåœ¨receiver_objectåƒåœ¾å›æ”¶æ—¶ä¼šè‡ªåŠ¨è§¦å‘_remove_receiveræ–¹æ³•ã€‚å¦‚æœå°†æ¸…é™¤è¿‡æ»¤Signal.receiversçš„è¿‡ç¨‹æ”¾åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œè€Œå…¶å®ƒåœ°æ–¹å¯èƒ½æ­£åœ¨åœ¨åŠ é”çš„æƒ…å†µä¸‹ä½¿ç”¨receiversåˆ™ä¼šå¯¼è‡´å†²çªã€‚æ•…_remove_receiversåªå°†Signal._dead_receiversç½®ä¸ºTrueï¼Œä»è€ŒæŠŠæ¸…ç†dead receiverçš„è¿‡ç¨‹å»¶è¿Ÿåˆ°äº†connectã€disconnectã€sendã€send_robustä¸­åŠ é”è¿›è¡Œ</p>
<h3 id="3-å¤§æ¦‚æµç¨‹">3. å¤§æ¦‚æµç¨‹
</h3><p>é€šè¿‡Signal.connectå‘Signal.receiversä¸­æ³¨å†Œå¯¹åº”çš„<code>((receiver_id, sender_id), receiver_weakref)</code>è®°å½•ï¼Œç„¶åsenderä¼šåœ¨æ°å½“çš„æ—¶å€™è°ƒç”¨æ°å½“çš„Signalå¹¶ä½¿ç”¨Signal.sendå‘é€æ°å½“çš„ä¿¡å·ç»™å¯¹åº”çš„æ‰€æœ‰receiverã€‚è¿™å°±æ˜¯ä¿¡å·çš„å¤§è‡´ä¼ é€’è¿‡ç¨‹</p>
<h3 id="4-å¾ˆå¥‡æ€ªçš„ä¸€ç‚¹">4. å¾ˆå¥‡æ€ªçš„ä¸€ç‚¹
</h3><p>ç¨‹åºé‡Œé¢æœ‰ä¸ªå¥‡æ€ªçš„<code>None</code>ï¼Œåœ¨connectæ—¶ä¸æŒ‡å®šsenderåˆ™senderï¼Œé»˜è®¤senderå°±ä¼šæ˜¯Noneï¼Œè€Œåœ¨senderä¸­è°ƒç”¨Siganl.sendæ–¹æ³•è¯¥æ–¹æ³•åˆä¼šè°ƒç”¨Signal._live_receiversæ–¹æ³•ï¼Œåœ¨Signal._live_receiversä¸­ä¼šå¯»æ‰¾è¯¥senderå¯¹åº”çš„receiverï¼Œè€ŒåŒ¹é…æ¡ä»¶å±…ç„¶æ˜¯<code>if r_senderkey == NONE_ID or r_senderkey == senderkey</code>ï¼Œsenderä¸ºNoneçš„receiversä¹Ÿä¼šè¢«åŒ¹é…ï¼Ÿæœ‰ç‚¹ä¸å¤ªç†è§£è¿™é‡Œçš„åšæ³•</p>
<h3 id="5-å¤šè¯´ä¸€å¥">5. å¤šè¯´ä¸€å¥
</h3><p>å¼‚æ­¥é—®é¢˜ï¼Œå½“ä¸€ä¸ªsenderæ³¨å†Œçš„receiverè¿‡å¤šæ—¶ï¼Œè°ƒç”¨sendæ–¹æ³•æ—¶å¯èƒ½ä¼šéå¸¸å ç”¨æ—¶é—´é€ æˆé˜»å¡ï¼Œè§‚å¯Ÿè€…æ¨¡å¼å¥½åƒéƒ½æœ‰è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨å¼‚æ­¥æ”¹å–„ï¼Ÿï¼ˆåœ¨ç½‘ä¸Šçœ‹åˆ°çš„ï¼Œå…·ä½“å¦‚ä½•æ”¹å–„æˆ‘è¿˜æ²¡ææ¸…æ¥šï¼Œç­‰å¼„æ˜ç™½äº†å†è¡¥ä¸Šâ€¦â€¦ï¼‰</p>
<h2 id="æºç ç®€æ">æºç ç®€æ
</h2><p>æºç ï¼š</p>
<ul>
<li><a class="link" href="https://github.com/django/django/blob/main/django/dispatch/dispatcher.py"  target="_blank" rel="noopener"
    >Github</a></li>
<li><a class="link" href="https://docs.djangoproject.com/zh-hans/3.0/_modules/django/dispatch/dispatcher/#Signal.disconnect"  target="_blank" rel="noopener"
    >Django Docs</a></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">threading</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">weakref</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">django.utils.inspect</span> <span class="kn">import</span> <span class="n">func_accepts_kwargs</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># è¿”å›å¯¹è±¡çš„id,åœ¨connectå­˜å‚¨è®°å½•å’ŒsendæŸ¥è¯¢è®°å½•æ—¶ä¼šç”¨åˆ°</span>
</span></span><span class="line"><span class="cl"><span class="c1"># æ³¨æ„ï¼šsenderå’Œreceiveréƒ½å¿…é¡»æ˜¯å¯å“ˆå¸Œçš„</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_make_id</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s1">&#39;__func__&#39;</span><span class="p">):</span>  <span class="c1"># å¦‚æœæ˜¯å¯¹è±¡æ–¹æ³•</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="vm">__self__</span><span class="p">),</span> <span class="nb">id</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="vm">__func__</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># django.utils.inspect.func_accepts_kwargs</span>
</span></span><span class="line"><span class="cl"><span class="c1"># æ£€æŸ¥ä¼ å…¥çš„å‡½æ•°æ˜¯å¦æ¥å—**kwargså‚æ•°</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">func_accepts_kwargs</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">any</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">VAR_KEYWORD</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">NONE_ID</span> <span class="o">=</span> <span class="n">_make_id</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># A marker for caching</span>
</span></span><span class="line"><span class="cl"><span class="n">NO_RECEIVERS</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Signal</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    æ‰€æœ‰signalçš„åŸºç±»
</span></span></span><span class="line"><span class="cl"><span class="s2">    Base class for all signals
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Internal attributes:
</span></span></span><span class="line"><span class="cl"><span class="s2">    
</span></span></span><span class="line"><span class="cl"><span class="s2">        receivers
</span></span></span><span class="line"><span class="cl"><span class="s2">            { receiverkey (id) : weakref(receiver) }
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">providing_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_caching</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        åˆ›å»ºæ–°çš„signal
</span></span></span><span class="line"><span class="cl"><span class="s2">        providing_args: åœ¨è°ƒç”¨send()æ–¹æ³•æ—¶å¯ä»¥ä¼ å…¥è¿™ä¸ªsignalçš„å‚æ•°åˆ—è¡¨
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">receivers</span> <span class="o">=</span> <span class="p">[]</span>  
</span></span><span class="line"><span class="cl">        <span class="c1"># ((receiver_id,sender_id),receiver_weakref)æˆ–è€…æ˜¯((dispatch_id,sender_id),receiverweak_ref)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å…·ä½“æ˜¯å¼ºå¼•ç”¨è¿˜æ˜¯weakrefå–å†³äºconnectæ—¶çš„weakå‚æ•°æ˜¯Trueè¿˜æ˜¯False</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># é»˜è®¤weakä¸ºTrueä½¿ç”¨å¼±å¼•ç”¨ï¼Œè‹¥ä¸ºFalseåˆ™åˆ é™¤è¯¥æ¡è®°å½•æ—¶éœ€è¦æ‰‹åŠ¨disconnect</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">providing_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">providing_args</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">providing_args</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">providing_args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>  <span class="c1"># åŠ é”ä¿è¯æ“ä½œæ•°æ®æ—¶çº¿ç¨‹å®‰å…¨</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">use_caching</span> <span class="o">=</span> <span class="n">use_caching</span>  <span class="c1"># æ˜¯å¦ä½¿ç”¨ç¼“å­˜</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ä¸ºäº†ä¾¿åˆ©å³ä½¿ä¸ä½¿ç”¨ç¼“å­˜æˆ‘ä»¬ä¹Ÿä¼šåˆ›å»ºç©ºçš„ç¼“å­˜</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å…³äºç¼“å­˜éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼šå¦‚æœuse_cachingä¸ºTrueï¼Œå¯¹äºæ¯ä¸€ä¸ªsender</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># æˆ‘ä»¬ä¼šåœ¨sender_receiver_cacheä¸­ç¼“å­˜å…¶æ‰€æœ‰çš„receiverã€‚</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è¯¥ç¼“å­˜åœ¨è°ƒç”¨.connect()æˆ–è€….disconnect()æ—¶ä¼šè¢«æ¸…é™¤ï¼Œè€Œåœ¨è°ƒç”¨sendæ—¶ä¼šè¢«å¡«å……</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">sender_receivers_cache</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">()</span> <span class="k">if</span> <span class="n">use_caching</span> <span class="k">else</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_dead_receivers</span> <span class="o">=</span> <span class="kc">False</span>  
</span></span><span class="line"><span class="cl">        <span class="c1"># receiverså±æ€§åˆ—è¡¨ä¸­æ˜¯å¦å«æœ‰â€œå¤±æ•ˆâ€çš„receiverå¼•ç”¨(å·²è¢«åƒåœ¾å›æ”¶)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># åœ¨_clear_dead_receiversæ–¹æ³•ä¸­ä¼šæ£€æŸ¥å…¶å€¼ï¼Œå¦‚æœä¸ºTrueåˆ™ä»£è¡¨å…¶ä¸­</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># æœ‰å¤±æ•ˆçš„receiverå¼•ç”¨ï¼Œåˆ™è¿‡æ»¤æ¸…ç†ä¸€éreceiverså±æ€§åˆ—è¡¨</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">receiver</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">weak</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dispatch_uid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        # é€šè¿‡signalå°†receiverè¿æ¥åˆ°sender
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        Arguments:
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            receiver
</span></span></span><span class="line"><span class="cl"><span class="s2">                A function or an instance method which is to receive signals.
</span></span></span><span class="line"><span class="cl"><span class="s2">                Receivers must be hashable objects.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">                If weak is True, then receiver must be weak referenceable.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">                Receivers must be able to accept keyword arguments.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">                If a receiver is connected with a dispatch_uid argument, it
</span></span></span><span class="line"><span class="cl"><span class="s2">                will not be added if another receiver was already connected
</span></span></span><span class="line"><span class="cl"><span class="s2">                with that dispatch_uid.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            sender
</span></span></span><span class="line"><span class="cl"><span class="s2">                The sender to which the receiver should respond. Must either be
</span></span></span><span class="line"><span class="cl"><span class="s2">                a Python object, or None to receive events from any sender.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            weak
</span></span></span><span class="line"><span class="cl"><span class="s2">                Whether to use weak references to the receiver. By default, the
</span></span></span><span class="line"><span class="cl"><span class="s2">                module will attempt to use weak references to the receiver
</span></span></span><span class="line"><span class="cl"><span class="s2">                objects. If this parameter is false, then strong references will
</span></span></span><span class="line"><span class="cl"><span class="s2">                be used.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            dispatch_uid
</span></span></span><span class="line"><span class="cl"><span class="s2">                An identifier used to uniquely identify a particular instance of
</span></span></span><span class="line"><span class="cl"><span class="s2">                a receiver. This will usually be a string, though it may be
</span></span></span><span class="line"><span class="cl"><span class="s2">                anything hashable.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># If DEBUG is on, check that we got a good receiver</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å¦‚æœåœ¨DEBUGæ¨¡å¼ä¸‹ï¼Œåˆ™æ£€æŸ¥è¯¥receiveræ˜¯å¦æ»¡è¶³è¦æ±‚</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">configured</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">assert</span> <span class="n">callable</span><span class="p">(</span><span class="n">receiver</span><span class="p">),</span> <span class="s2">&#34;Signal receivers must be callable.&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Check for **kwargs</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">func_accepts_kwargs</span><span class="p">(</span><span class="n">receiver</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;Signal receivers must accept keyword arguments (**kwargs).&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">dispatch_uid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">lookup_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">dispatch_uid</span><span class="p">,</span> <span class="n">_make_id</span><span class="p">(</span><span class="n">sender</span><span class="p">))</span>  <span class="c1"># å¦‚æœè®¾ç½®äº†dispatch_uidä½œä¸ºæŸreceiverçš„æ ‡è¯†</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">lookup_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">_make_id</span><span class="p">(</span><span class="n">receiver</span><span class="p">),</span> <span class="n">_make_id</span><span class="p">(</span><span class="n">sender</span><span class="p">))</span>  <span class="c1"># æ²¡æœ‰dispatch_uidåˆ™ä½¿ç”¨receiverçš„id</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">weak</span><span class="p">:</span>  <span class="c1"># å¦‚æœä½¿ç”¨weakåˆ™å­˜å‚¨è¯¥receiverçš„å¼±å¼•ç”¨ï¼Œå¦åˆ™å°±ç›´æ¥å­˜å‚¨å¼ºå¼•ç”¨(å¼ºå¼•ç”¨æœ€ç»ˆéœ€è¦æ‰‹åŠ¨disconnect)</span>
</span></span><span class="line"><span class="cl">            <span class="n">ref</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span>
</span></span><span class="line"><span class="cl">            <span class="n">receiver_object</span> <span class="o">=</span> <span class="n">receiver</span>  <span class="c1"># å¼ºå¼•ç”¨</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Check for bound methods</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">receiver</span><span class="p">,</span> <span class="s1">&#39;__self__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">receiver</span><span class="p">,</span> <span class="s1">&#39;__func__&#39;</span><span class="p">):</span>  <span class="c1"># æ£€æŸ¥æ˜¯å¦æ˜¯å¯¹è±¡æ–¹æ³•</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># https://docs.python.org/zh-cn/3/library/weakref.html#weakref.WeakMethod</span>
</span></span><span class="line"><span class="cl">                <span class="n">ref</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakMethod</span>
</span></span><span class="line"><span class="cl">                <span class="n">receiver_object</span> <span class="o">=</span> <span class="n">receiver</span><span class="o">.</span><span class="vm">__self__</span>  <span class="c1"># åŒ…å«è¯¥å¯¹è±¡æ–¹æ³•çš„å¯¹è±¡</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># ä½¿ç”¨å¼±å¼•ç”¨æ›¿ä»£å¼ºå¼•ç”¨</span>
</span></span><span class="line"><span class="cl">            <span class="n">receiver</span> <span class="o">=</span> <span class="n">ref</span><span class="p">(</span><span class="n">receiver</span><span class="p">)</span>  <span class="c1"># æ™®é€šå‡½æ•°æ–¹æ³•åˆ™ç›´æ¥å–å…¶å¼±å¼•ç”¨</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># å½“receiveræ–¹æ³•ã€æˆ–åŒ…å«è¯¥æ–¹æ³•å¯¹è±¡æ¶ˆäº¡æ—¶ä»signalçš„receiversåˆ—è¡¨ä¸­æ¸…é™¤è¯¥æ¡è®°å½•</span>
</span></span><span class="line"><span class="cl">            <span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">receiver_object</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_receiver</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># https://docs.python.org/zh-cn/3/library/weakref.html#weakref.finalize</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># å½“receiverå¯¹è±¡åƒåœ¾å›æ”¶æ—¶è°ƒç”¨_remove_receiverç½®self._dead_receivers = True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_clear_dead_receivers</span><span class="p">()</span>  <span class="c1"># æ¸…é™¤ã€è¿‡æ»¤dead_receivers</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">r_key</span> <span class="o">==</span> <span class="n">lookup_key</span> <span class="k">for</span> <span class="n">r_key</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">receivers</span><span class="p">):</span>  <span class="c1"># æŸ¥é‡</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">receivers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">lookup_key</span><span class="p">,</span> <span class="n">receiver</span><span class="p">))</span>  <span class="c1"># æ·»åŠ ((receiver_id,sender_id),receiver_weakref)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">sender_receivers_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="c1"># å˜æ›´åæ¸…é™¤ç¼“å­˜</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">receiver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dispatch_uid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        å°†signalä¸­çš„receiverä¸senderâ€œæ–­å¼€è¿æ¥â€
</span></span></span><span class="line"><span class="cl"><span class="s2">        è¯¥å‡½æ•°ä¸»è¦é’ˆå¯¹é‚£äº›åœ¨connectæ—¶weakå‚æ•°ä¸ºFalseçš„æƒ…å†µï¼Œå³signalçš„receiversåˆ—è¡¨
</span></span></span><span class="line"><span class="cl"><span class="s2">        ä¸­å­˜å‚¨çš„æ˜¯rceiverçš„å¼ºå¼•ç”¨
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        å¦‚æœåœ¨connectæ—¶ä½¿ç”¨çš„å¼±å¼•ç”¨(weak=True), åˆ™ä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨disconnectæ–¹æ³•
</span></span></span><span class="line"><span class="cl"><span class="s2">        receiverå’Œsenderçš„è®°å½•ä¼šè¢«è‡ªåŠ¨åˆ é™¤
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        Arguments:
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            receiver
</span></span></span><span class="line"><span class="cl"><span class="s2">                The registered receiver to disconnect. May be none if
</span></span></span><span class="line"><span class="cl"><span class="s2">                dispatch_uid is specified.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            sender
</span></span></span><span class="line"><span class="cl"><span class="s2">                The registered sender to disconnect
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            dispatch_uid
</span></span></span><span class="line"><span class="cl"><span class="s2">                the unique identifier of the receiver to disconnect
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">dispatch_uid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">lookup_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">dispatch_uid</span><span class="p">,</span> <span class="n">_make_id</span><span class="p">(</span><span class="n">sender</span><span class="p">))</span>  <span class="c1"># å¦‚æœæä¾›äº†dispatch_uidåˆ™ä½¿ç”¨å…¶æ›¿ä»£ id(receiver)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">lookup_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">_make_id</span><span class="p">(</span><span class="n">receiver</span><span class="p">),</span> <span class="n">_make_id</span><span class="p">(</span><span class="n">sender</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">disconnected</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_clear_dead_receivers</span><span class="p">()</span>  <span class="c1"># å…ˆæ¸…é™¤dead_receivers</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">receivers</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="n">r_key</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">receivers</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">r_key</span> <span class="o">==</span> <span class="n">lookup_key</span><span class="p">:</span>  <span class="c1"># æ ¹æ®lookup_keyåœ¨self.receiversä¸­æŸ¥æ‰¾</span>
</span></span><span class="line"><span class="cl">                    <span class="n">disconnected</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">receivers</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>  <span class="c1"># åˆ é™¤self.receiversä¸­çš„å¯¹åº”è®°å½•</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">sender_receivers_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="c1"># å˜æ›´åæ¸…é™¤ç¼“å­˜</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">disconnected</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">has_listeners</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># é€šè¿‡è°ƒç”¨_live_receiversæ–¹æ³•çœ‹senderçš„reciversæ˜¯å¦ä¸ºç©º</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_live_receivers</span><span class="p">(</span><span class="n">sender</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="o">**</span><span class="n">named</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Send signal from sender to all connected receivers.
</span></span></span><span class="line"><span class="cl"><span class="s2">        ä»senderä¸­å‘é€ä¿¡å·ç»™æ‰€æœ‰è¿æ¥åˆ°è¯¥senderçš„receiver
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        If any receiver raises an error, the error propagates back through send,
</span></span></span><span class="line"><span class="cl"><span class="s2">        terminating the dispatch loop. So it&#39;s possible that all receivers
</span></span></span><span class="line"><span class="cl"><span class="s2">        won&#39;t be called if an error is raised.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        Arguments:
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            sender
</span></span></span><span class="line"><span class="cl"><span class="s2">                The sender of the signal. Either a specific object or None.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            named
</span></span></span><span class="line"><span class="cl"><span class="s2">                Named arguments which will be passed to receivers.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        Return a list of tuple pairs [(receiver, response), ... ].
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">receivers</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender_receivers_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span> <span class="ow">is</span> <span class="n">NO_RECEIVERS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># å¦‚æœè¯¥signalå¾—receiversä¸ºç©ºæˆ–è€…è¯¥senderå¯¹åº”çš„receiversç¼“å­˜ä¸ºç©º</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="n">receiver</span><span class="p">,</span> <span class="n">receiver</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">sender</span><span class="p">,</span> <span class="o">**</span><span class="n">named</span><span class="p">))</span>  <span class="c1"># è¿™é‡Œçš„receiverå°±æ˜¯å…·ä½“çš„receiverå‡½æ•°</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">receiver</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_live_receivers</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># _live_receiverè¿”å›çš„æ˜¯receiverçš„å¯è°ƒç”¨å¯¹è±¡(å°±æ˜¯å…·ä½“çš„receiverå‡½æ•°ï¼Œå¼ºå¼•ç”¨)çš„åˆ—è¡¨</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è¿”å›[(receiverå‡½æ•°,è°ƒç”¨receiverå‡½æ•°çš„ç»“æœ)]å¦‚æœè°ƒç”¨æŸä¸ªreceiveræ—¶å‘ç”Ÿå¼‚å¸¸ç¨‹åºä¼šç›´æ¥é€€å‡º</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># å¯¼è‡´å…¶ä»–çš„å‰©ä¸‹çš„receiverå¹¶æœªè¢«æ‰§è¡Œ</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">send_robust</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="o">**</span><span class="n">named</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Send signal from sender to all connected receivers catching errors.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        Arguments:
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            sender
</span></span></span><span class="line"><span class="cl"><span class="s2">                The sender of the signal. Can be any Python object (normally one
</span></span></span><span class="line"><span class="cl"><span class="s2">                registered with a connect if you actually want something to
</span></span></span><span class="line"><span class="cl"><span class="s2">                occur).
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            named
</span></span></span><span class="line"><span class="cl"><span class="s2">                Named arguments which will be passed to receivers. These
</span></span></span><span class="line"><span class="cl"><span class="s2">                arguments must be a subset of the argument names defined in
</span></span></span><span class="line"><span class="cl"><span class="s2">                providing_args.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        Return a list of tuple pairs [(receiver, response), ... ].
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        If any receiver raises an error (specifically any subclass of
</span></span></span><span class="line"><span class="cl"><span class="s2">        Exception), return the error instance as the result for that receiver.
</span></span></span><span class="line"><span class="cl"><span class="s2">        ç›¸æ¯”sendæ–¹æ³•è°ƒç”¨receiveræ–¹æ³•å¼‚å¸¸æ—¶ç›´æ¥é€€å‡ºï¼Œsend_robustä¼šæ”¶é›†å¼‚å¸¸å¹¶è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">receivers</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender_receivers_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span> <span class="ow">is</span> <span class="n">NO_RECEIVERS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Call each receiver with whatever arguments it can accept.</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Return a list of tuple pairs [(receiver, response), ... ].</span>
</span></span><span class="line"><span class="cl">        <span class="n">responses</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">receiver</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_live_receivers</span><span class="p">(</span><span class="n">sender</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">response</span> <span class="o">=</span> <span class="n">receiver</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">sender</span><span class="p">,</span> <span class="o">**</span><span class="n">named</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">responses</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">receiver</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">                <span class="c1"># å¦‚æœè°ƒç”¨receiverå‡ºç°å¼‚å¸¸åˆ™æ•è·å¹¶è¿”å›ç›¸åº”çš„å¼‚å¸¸è€Œä¸å½±å“å…¶ä»–receiverçš„è°ƒç”¨</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">responses</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">receiver</span><span class="p">,</span> <span class="n">response</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">responses</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_clear_dead_receivers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Note: caller is assumed to hold self.lock.</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># æ¸…é™¤dead_receivers</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dead_receivers</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_dead_receivers</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">receivers</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">receivers</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ReferenceType</span><span class="p">)</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># å¼±å¼•ç”¨ï¼Œå¹¶ä¸”è¯¥å¼±å¼•ç”¨å¯¹åº”çš„å¯¹è±¡å·²æ¶ˆäº¡</span>
</span></span><span class="line"><span class="cl">            <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_live_receivers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Filter sequence of receivers to get resolved, live receivers.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        This checks for weak references and resolves them, then returning only
</span></span></span><span class="line"><span class="cl"><span class="s2">        live receivers.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">receivers</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_caching</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dead_receivers</span><span class="p">:</span>  <span class="c1"># å¦‚æœä½¿ç”¨ç¼“å­˜å¹¶ä¸”self.receiversä¸­æ— dead_receivers</span>
</span></span><span class="line"><span class="cl">            <span class="n">receivers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender_receivers_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span>  <span class="c1"># ç›´æ¥ä»ç¼“å­˜ä¸­è·å–</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># We could end up here with NO_RECEIVERS even if we do check this case in</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># .send() prior to calling _live_receivers() due to concurrent .send() call.</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># åœ¨è°ƒç”¨_live_receiversæ–¹æ³•çš„æ–¹æ³•ä¸­å·²ç»æ£€æŸ¥è¿‡ä¸€æ¬¡äº†</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">receivers</span> <span class="ow">is</span> <span class="n">NO_RECEIVERS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">receivers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># å¦‚æœä¸ä½¿ç”¨ç¼“å­˜æˆ–è€…å­˜åœ¨å¾…æ¸…ç†çš„dead receivers</span>
</span></span><span class="line"><span class="cl">            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_clear_dead_receivers</span><span class="p">()</span>  <span class="c1"># å…ˆæ¸…ç†dead_receivers</span>
</span></span><span class="line"><span class="cl">                <span class="n">senderkey</span> <span class="o">=</span> <span class="n">_make_id</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">receivers</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="p">(</span><span class="n">receiverkey</span><span class="p">,</span> <span class="n">r_senderkey</span><span class="p">),</span> <span class="n">receiver</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">receivers</span><span class="p">:</span> <span class="c1"># éå†self.receiversè¿›è¡ŒæŸ¥æ‰¾åŒ¹é…</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">r_senderkey</span> <span class="o">==</span> <span class="n">NONE_ID</span> <span class="ow">or</span> <span class="n">r_senderkey</span> <span class="o">==</span> <span class="n">senderkey</span><span class="p">:</span>  <span class="c1"># å¦‚æœsenderkeyä¸ºid(None)æˆ–åŒ¹é…</span>
</span></span><span class="line"><span class="cl">                        <span class="n">receivers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">receiver</span><span class="p">)</span>  <span class="c1"># å°†receiver(weakref)æ·»åŠ åˆ°receiversä¸­</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># æ›´æ–°ç¼“å­˜</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_caching</span><span class="p">:</span>  <span class="c1"># å¦‚æœä½¿ç”¨ç¼“å­˜</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="ow">not</span> <span class="n">receivers</span><span class="p">:</span>  <span class="c1"># å¦‚æœè¯¥senderæ²¡æœ‰receiver (receiversä¸ºç©º)</span>
</span></span><span class="line"><span class="cl">                        <span class="bp">self</span><span class="o">.</span><span class="n">sender_receivers_cache</span><span class="p">[</span><span class="n">sender</span><span class="p">]</span> <span class="o">=</span> <span class="n">NO_RECEIVERS</span>  <span class="c1"># å°†cacheä¸­è¯¥senderçš„receiversç½®ä¸ºç©º</span>
</span></span><span class="line"><span class="cl">                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># å¦‚æœè¯¥senderå­˜åœ¨å¯¹åº”çš„receiver</span>
</span></span><span class="line"><span class="cl">                        <span class="c1"># Note, we must cache the weakref versions.</span>
</span></span><span class="line"><span class="cl">                        <span class="c1"># æ³¨æ„æˆ‘ä»¬åº”è¯¥ç¼“å­˜å¼±å¼•ç”¨</span>
</span></span><span class="line"><span class="cl">                        <span class="bp">self</span><span class="o">.</span><span class="n">sender_receivers_cache</span><span class="p">[</span><span class="n">sender</span><span class="p">]</span> <span class="o">=</span> <span class="n">receivers</span>  <span class="c1"># å°†è¯¥senderåŠå…¶æ‰€æœ‰çš„receiversç¼“å­˜èµ·æ¥</span>
</span></span><span class="line"><span class="cl">        <span class="n">non_weak_receivers</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">receiver</span> <span class="ow">in</span> <span class="n">receivers</span><span class="p">:</span>  <span class="c1"># receiversè¦ä¹ˆä¸º[] è¦ä¹ˆä¸º[receiver]</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">receiver</span><span class="p">,</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ReferenceType</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Dereference the weak reference.</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># https://www.kite.com/python/docs/weakref.ReferenceType</span>
</span></span><span class="line"><span class="cl">                <span class="n">receiver</span> <span class="o">=</span> <span class="n">receiver</span><span class="p">()</span>  <span class="c1"># è·å–å¼±å¼•ç”¨æ‰€æŒ‡çš„å®é™…å¯¹è±¡ï¼Œè‹¥å·²æ¶ˆäº¡åˆ™è¿”å›Noneï¼Œå¦åˆ™è¿”å›å¯¹è±¡çš„å¼ºå¼•ç”¨(â€œå¯ç›´æ¥è°ƒç”¨â€)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">receiver</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># refæ‰€æŒ‡çš„åŸå¯¹è±¡å°šæœªæ¶ˆäº¡</span>
</span></span><span class="line"><span class="cl">                    <span class="n">non_weak_receivers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">receiver</span><span class="p">)</span>  <span class="c1"># æ·»åŠ å®é™…å¯è°ƒç”¨çš„å¯¹è±¡</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">non_weak_receivers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">receiver</span><span class="p">)</span>  <span class="c1"># ä¸æ˜¯å¼±å¼•ç”¨åˆ™ç›´æ¥æ·»åŠ </span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">non_weak_receivers</span>  <span class="c1"># å¯è°ƒç”¨å¯¹è±¡receiverçš„åˆ—è¡¨</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_remove_receiver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">receiver</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Mark that the self.receivers list has dead weakrefs. If so, we will</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># clean those up in connect, disconnect and _live_receivers while</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># holding self.lock. Note that doing the cleanup here isn&#39;t a good</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># idea, _remove_receiver() will be called as side effect of garbage</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># collection, and so the call can happen while we are already holding</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># self.lock.</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># æ ‡è®°self.receiversä¸­æœ‰dead weakrefs(weakrefæ‰€æŒ‡å¯¹è±¡å·²æ¶ˆäº¡).å¦‚æœå­˜åœ¨dead receiver</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ç¨‹åºä¼šåœ¨è°ƒç”¨connect, disconnectå’Œ_live_receiversæ—¶åœ¨åŠ é”çš„æƒ…å†µä¸‹æ¸…é™¤dead weakrefs</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># æ³¨æ„åœ¨è¿™é‡Œæ‰§è¡Œå…·ä½“çš„æ¸…é™¤æ“ä½œå¹¶ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ï¼Œåœ¨åƒåœ¾å›æ”¶æ—¶_remove_receiver()ä¼šè¢«</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è‡ªåŠ¨è§¦å‘ï¼Œè€Œæˆ‘ä»¬å¯èƒ½åœ¨å…¶ä»–æ“ä½œä¸­å¯¹receiversåŠ äº†é”ï¼Œæ­¤æ—¶æ¸…ç†receiverså°†ä¼šå¯¼è‡´å†²çª</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_dead_receivers</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">receiver</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    A decorator for connecting receivers to signals. Used by passing in the
</span></span></span><span class="line"><span class="cl"><span class="s2">    signal (or list of signals) and keyword arguments to connect::
</span></span></span><span class="line"><span class="cl"><span class="s2">    ç”¨æ¥å°†receiversè¿æ¥åˆ°å¯¹åº”signalçš„è£…é¥°å™¨. ä½¿ç”¨æ—¶ä¼ å…¥signal(æˆ–è€…æ˜¯è£…æœ‰signalçš„åˆ—è¡¨)
</span></span></span><span class="line"><span class="cl"><span class="s2">    ä»¥åŠç›¸å…³çš„å…³é”®å­—å‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        @receiver(post_save, sender=MyModel)
</span></span></span><span class="line"><span class="cl"><span class="s2">        def signal_receiver(sender, **kwargs):
</span></span></span><span class="line"><span class="cl"><span class="s2">            ...
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        @receiver([post_save, post_delete], sender=MyModel)
</span></span></span><span class="line"><span class="cl"><span class="s2">        def signals_receiver(sender, **kwargs):
</span></span></span><span class="line"><span class="cl"><span class="s2">            ...
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>  <span class="c1"># ä¼ å…¥çš„æ˜¯signalåˆ—è¡¨</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">signal</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># è°ƒç”¨connectæ–¹æ³•ï¼Œsenderçš„ä¿¡æ¯åŒ…å«åœ¨kwargsä¸­äº†</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">signal</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">func</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">_decorator</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é™¤æ­¤ä¹‹å¤–ï¼Œdjangoå·²ç»ä¸ºæˆ‘ä»¬é¢„ç½®äº†ä¸€äº›ä¿¡å·:</p>
<p><code>pre_init</code>ã€<code>post_init</code>ã€<code>pre_save</code>ã€<code>post_save</code>ã€<code>pre_delete</code>ã€<code>post_delete</code>ã€<code>m2m_change</code>â€¦â€¦(<a class="link" href="https://docs.djangoproject.com/zh-hans/3.0/ref/signals/"  target="_blank" rel="noopener"
    >è¯¦ç»†ç”¨æ³•è§å®˜æ–¹æ–‡æ¡£</a>)</p>
<p>djangoåœ¨<a class="link" href="https://github.com/django/django/blob/main/django/db/models/signals.py"  target="_blank" rel="noopener"
    ><code>django/db/models/signals.py</code></a>ä¸­å®šä¹‰äº†ä¸æ•°æ®åº“Modelç›¸å…³çš„ä¿¡å·å¯¹è±¡:</p>
<ul>
<li><a class="link" href="https://docs.djangoproject.com/zh-hans/3.0/ref/signals/#pre-init"  target="_blank" rel="noopener"
    >pre_init &amp; post_init</a></li>
<li><a class="link" href="https://docs.djangoproject.com/zh-hans/3.0/ref/signals/#pre-save"  target="_blank" rel="noopener"
    >pre_save &amp; post_save</a></li>
<li><a class="link" href="https://docs.djangoproject.com/zh-hans/3.0/ref/signals/#pre-delete"  target="_blank" rel="noopener"
    >pre_delete &amp; post_delete</a></li>
<li><a class="link" href="https://docs.djangoproject.com/zh-hans/3.0/ref/signals/#m2m-changed"  target="_blank" rel="noopener"
    >m2m_change</a></li>
<li><a class="link" href="https://docs.djangoproject.com/zh-hans/3.0/ref/signals/#class-prepared"  target="_blank" rel="noopener"
    >class_prepared</a></li>
<li><a class="link" href="https://docs.djangoproject.com/zh-hans/3.0/ref/signals/#pre-migrate"  target="_blank" rel="noopener"
    >pre_migrate &amp; post_migrate</a></li>
</ul>
<p>åœ¨<a class="link" href="https://github.com/django/django/blob/main/django/core/signals.py"  target="_blank" rel="noopener"
    ><code>django/core/signals.py</code></a>ä¸­å®šä¹‰äº†ä¸requestå’Œsettingç›¸å…³çš„ä¿¡å·å¯¹è±¡:</p>
<ul>
<li><a class="link" href="https://docs.djangoproject.com/zh-hans/3.0/ref/signals/#request-started"  target="_blank" rel="noopener"
    >request_started &amp; request_finished</a></li>
<li><a class="link" href="https://docs.djangoproject.com/zh-hans/3.0/ref/signals/#got-request-exception"  target="_blank" rel="noopener"
    >got_request_exception</a></li>
<li><a class="link" href="https://docs.djangoproject.com/zh-hans/3.0/ref/signals/#setting-changed"  target="_blank" rel="noopener"
    >setting_changed</a></li>
</ul>
<p>djangoä¸ºæˆ‘ä»¬é¢„ç½®è¿™äº›ä¿¡å·å¯¹è±¡ï¼Œå¹¶ä¸”åœ¨<u>é€‚å½“çš„æ—¶å€™</u>è°ƒç”¨<u>é€‚å½“çš„ä¿¡å·å¯¹è±¡</u>å‘é€<u>é€‚å½“çš„â€œä¿¡å·â€</u>ã€‚æ¯”å¦‚åœ¨<a class="link" href="https://github.com/django/django/blob/316cc34d046ad86e100227772294f906fae1c2e5/django/db/models/base.py#L404"  target="_blank" rel="noopener"
    ><code>django/db/models/base.py</code></a>ä¸­ï¼Œåœ¨Modelç±»çš„__init__æ–¹æ³•å¼€å§‹ä½ç½®è°ƒç”¨<a class="link" href="https://github.com/django/django/blob/316cc34d046ad86e100227772294f906fae1c2e5/django/db/models/base.py#L415"  target="_blank" rel="noopener"
    >pre_init.send()</a>åœ¨__init__çš„ç»“æŸä½ç½®è°ƒç”¨<a class="link" href="https://github.com/django/django/blob/316cc34d046ad86e100227772294f906fae1c2e5/django/db/models/base.py#L509"  target="_blank" rel="noopener"
    >post_init.send()</a>ï¼Œè€Œæˆ‘ä»¬çš„modelåˆéƒ½æ˜¯ç»§æ‰¿è‡ªè¯¥Modelã€‚</p>
<p>djangoä¸ºæˆ‘ä»¬é¢„ç½®å¥½äº†ä¸€äº›ä¿¡å·ï¼Œå¹¶ä¸”åœ¨åšç›¸åº”æ“ä½œæ—¶ä¼šå‘é€å¯¹åº”çš„ä¿¡å·ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯åœ¨éœ€è¦ç”¨åˆ°æ—¶ï¼Œå®šä¹‰å¯¹åº”çš„receiverå»æ¥æ”¶å¯¹åº”çš„ä¿¡å·ğŸ“¶å³å¯ã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥å®ä¾‹åŒ–æˆ–ç»§æ‰¿Signalç±»æ¥å®šä¹‰æˆ‘ä»¬è‡ªå·±çš„ä¿¡å·ã€‚å…·ä½“çš„ä½¿ç”¨å¯ä»¥å‚è§<a class="link" href="https://www.liujiangblog.com/course/django/170"  target="_blank" rel="noopener"
    >è¿™ç¯‡åšå®¢</a></p>
<h2 id="ä¸€äº›å¯èƒ½æœ‰ç”¨çš„é“¾æ¥">ä¸€äº›å¯èƒ½æœ‰ç”¨çš„é“¾æ¥
</h2><ul>
<li><a class="link" href="https://docs.python.org/zh-cn/3/library/weakref.html"  target="_blank" rel="noopener"
    >Python å¼±å¼•ç”¨</a></li>
<li>Python åƒåœ¾å›æ”¶
<ol>
<li><a class="link" href="https://docs.python.org/zh-cn/3.8/library/gc.html"  target="_blank" rel="noopener"
    >python gcæ¨¡å—æ¥å£æ–‡æ¡£</a></li>
<li><a class="link" href="https://www.jianshu.com/p/1e375fb40506"  target="_blank" rel="noopener"
    >ç®€ä¹¦ Pythonåƒåœ¾å›æ”¶æœºåˆ¶</a></li>
<li><a class="link" href="https://zhuanlan.zhihu.com/p/83251959"  target="_blank" rel="noopener"
    >çŸ¥ä¹ Pythonåƒåœ¾å›æ”¶æœºåˆ¶</a></li>
</ol>
</li>
</ul>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/python/">Python</a>
        
            <a href="/tags/django/">Django</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/top-6-django-decorators/">
        
        
            <div class="article-image">
                <img src="/p/top-6-django-decorators/top-6-django-decorators.3d19f1f09ba5d940aa0d60f9a5aff2b4_hu7783161890850055115.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Top 6 Django Decorators"
                        data-key="top-6-django-decorators" 
                        data-hash="md5-PRnx8Jul2UCqDWD5pa/ytA==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Top 6 Django Decorators</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/internal-sort/">
        
        
            <div class="article-image">
                <img src="/p/internal-sort/internal-sort.de55f3fac40b7cda92238bd6566e842d_hu829372757959253208.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post å¸¸ç”¨å†…éƒ¨æ’åºç®—æ³•"
                        data-key="internal sort" 
                        data-hash="md5-3lXz&#43;sQLfNqSI4vWVm6ELQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">å¸¸ç”¨å†…éƒ¨æ’åºç®—æ³•</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/zxcvbn-explained/">
        
        
            <div class="article-image">
                <img src="/p/zxcvbn-explained/artiom-vallat-y7nZ4ENg7ic-unsplash.2283c5d768410121dca955c3526137a3_hu3144410286309968048.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post zxcvbn åŸç†è¯¦è§£"
                        data-key="zxcvbn explained" 
                        data-hash="md5-IoPF12hBASHcqVXDUmE3ow==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">zxcvbn åŸç†è¯¦è§£</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/analyzing-libpcap-pcap-file/">
        
        
            <div class="article-image">
                <img src="/p/analyzing-libpcap-pcap-file/cover.c098cdcd1ed9e47f7e0c93684c782214_hu2080152033521557187.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Libpcapæ ¼å¼pcapåŒ…åˆ†æ"
                        data-key="analyzing libpcap pcap file" 
                        data-hash="md5-wJjNzR7Z5H9&#43;DJNoTHgiFA==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Libpcapæ ¼å¼pcapåŒ…åˆ†æ</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/implementing-a-trie-in-python/">
        
        
            <div class="article-image">
                <img src="/p/implementing-a-trie-in-python/trie.02fdb0bd3268abc47c744733f52d5d50_hu7520324502837500842.jpeg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Implementing a Trie in Python"
                        data-key="implementing a trie in Python" 
                        data-hash="md5-Av2wvTJoq8R8dEcz9S1dUA==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Implementing a Trie in Python</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "heaciy" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (typeof DISQUS == 'object') {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2019 - 
        
        2025 Heaciy&#39;s Blog
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
